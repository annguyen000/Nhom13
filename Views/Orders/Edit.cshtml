@model Nhom13.Models.Order

@{
    ViewData["Title"] = "Chỉnh sửa đơn hàng";
}

<div class="container-fluid">
    <h1>@ViewData["Title"]</h1>

    <form asp-action="Edit" id="orderForm">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="CreatedDate" />
        <input type="hidden" asp-for="CreatedBy" />

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label asp-for="CustomerName" class="control-label"></label>
                    <input asp-for="CustomerName" class="form-control" />
                    <span asp-validation-for="CustomerName" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="CustomerPhone" class="control-label"></label>
                    <input asp-for="CustomerPhone" class="form-control" />
                    <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="CustomerEmail" class="control-label"></label>
                    <input asp-for="CustomerEmail" class="form-control" type="email" />
                    <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="CustomerAddress" class="control-label"></label>
                    <textarea asp-for="CustomerAddress" class="form-control"></textarea>
                    <span asp-validation-for="CustomerAddress" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Status" class="control-label"></label>
                    <select asp-for="Status" class="form-control">
                        <option value="Pending">Chờ xử lý</option>
                        <option value="Processing">Đang xử lý</option>
                        <option value="Shipping">Đang giao hàng</option>
                        <option value="Completed">Hoàn thành</option>
                        <option value="Cancelled">Đã hủy</option>
                    </select>
                    <span asp-validation-for="Status" class="text-danger"></span>
                </div>
            </div>
        </div>

        <h3 class="mt-4">Chi tiết đơn hàng</h3>
        <div class="table-responsive">
            <table class="table table-bordered" id="orderDetailsTable">
                <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Đơn giá</th>
                        <th>Thành tiền</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.OrderDetails != null)
                    {
                        @for (var i = 0; i < Model.OrderDetails.Count; i++)
                        {
                            var detail = Model.OrderDetails[i];
                            <tr>
                                <td>
                                    <select name="OrderDetails[@i].ProductId" class="form-control product-select" onchange="updateUnitPrice(this)">
                                        <option value="">-- Chọn sản phẩm --</option>
                                        @foreach (var product in ViewBag.Products)
                                        {
                                            if (product.Id == detail.ProductId)
                                            {
                                                <option value="@product.Id" data-price="@product.Price" selected>@product.Name</option>
                                            }
                                            else
                                            {
                                                <option value="@product.Id" data-price="@product.Price">@product.Name</option>
                                            }
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input type="number" name="OrderDetails[@i].Quantity" class="form-control quantity-input" 
                                           value="@detail.Quantity" min="1" onchange="updateAmount(this)"/>
                                </td>
                                <td>
                                    <input type="number" name="OrderDetails[@i].UnitPrice" class="form-control unit-price-input" 
                                           value="@detail.UnitPrice" readonly/>
                                </td>
                                <td>
                                    <input type="number" name="OrderDetails[@i].Amount" class="form-control amount-input" 
                                           value="@detail.Amount" readonly/>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderDetail(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-info mb-3" onclick="addOrderDetail()">
            <i class="fas fa-plus"></i> Thêm sản phẩm
        </button>

        <div class="form-group mt-4">
            <input type="submit" value="Lưu thay đổi" class="btn btn-primary" />
            <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        let products = @Html.Raw(Json.Serialize(ViewBag.Products));
        let detailIndex = @(Model.OrderDetails?.Count ?? 0);

        function addOrderDetail() {
            let template = `
                <tr>
                    <td>
                        <select name="OrderDetails[${detailIndex}].ProductId" class="form-control product-select" onchange="updateUnitPrice(this)">
                            <option value="">-- Chọn sản phẩm --</option>
                            ${products.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="number" name="OrderDetails[${detailIndex}].Quantity" class="form-control quantity-input" value="1" min="1" onchange="updateAmount(this)"/>
                    </td>
                    <td>
                        <input type="number" name="OrderDetails[${detailIndex}].UnitPrice" class="form-control unit-price-input" readonly/>
                    </td>
                    <td>
                        <input type="number" name="OrderDetails[${detailIndex}].Amount" class="form-control amount-input" readonly/>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeOrderDetail(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#orderDetailsTable tbody').append(template);
            detailIndex++;
        }

        function updateUnitPrice(select) {
            let row = $(select).closest('tr');
            let selectedOption = $(select).find('option:selected');
            let price = selectedOption.data('price') || 0;
            
            row.find('.unit-price-input').val(price);
            updateAmount(row.find('.quantity-input'));
        }

        function updateAmount(input) {
            let row = $(input).closest('tr');
            let quantity = parseFloat(row.find('.quantity-input').val()) || 0;
            let unitPrice = parseFloat(row.find('.unit-price-input').val()) || 0;
            let amount = quantity * unitPrice;
            
            row.find('.amount-input').val(amount);
        }

        function removeOrderDetail(button) {
            $(button).closest('tr').remove();
        }

        // Form validation
        $('#orderForm').submit(function(e) {
            let details = $('#orderDetailsTable tbody tr');
            if (details.length === 0) {
                e.preventDefault();
                alert('Vui lòng thêm ít nhất một sản phẩm vào đơn hàng');
                return false;
            }

            let isValid = true;
            details.each(function() {
                let productId = $(this).find('.product-select').val();
                if (!productId) {
                    e.preventDefault();
                    alert('Vui lòng chọn sản phẩm cho tất cả các dòng');
                    isValid = false;
                    return false;
                }
            });

            return isValid;
        });
    </script>
} 